<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - ROTA+</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='grafico.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>ROTA+</h2>
        <ul>
            <li>Dashboard</li>
            <li>Alunos</li>
            <li>Veículos</li>
            <li>Rotas</li>
            <li>Despesas</li>
            <li>Configurações</li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main">

        <!-- Filtros -->
        <div class="filter">
            <div>
                <img class="icon-img-filter" src="https://img.icons8.com/pastel-glyph/64/filter.png" alt="Filtro">
            </div>
            <div class="filter-date">
                <div class="date-item">
                    <label class="date-label" for="start-date">Início: </label>
                    <input type="date" id="start-date">
                </div>
                <div class="date-item">
                    <label class="date-label" for="end-date">Fim: </label>
                    <input type="date" id="end-date">
                </div>
            </div>
            <div class="filter-route">
                <select id="route">
                    <option value="all">Todas as Rotas</option>
                </select>
            </div>
        </div>

        <!-- Cards -->
        <div class="cards">
            <div class="card">
                <h3 id="card-alunos">0</h3>
                <p>Quantidade de Alunos</p>
            </div>
            <div class="card">
                <h3 id="card-novos">0</h3>
                <p>Novos Alunos</p>
            </div>
            <div class="card">
                <h3 id="card-escolas">0</h3>
                <p>Número de Escolas</p>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="charts">
            <div class="chart-box" id="chart1">
                <h3>Frequência Geral</h3>
                <canvas id="graficoLinha"></canvas>
            </div>
            <div class="chart-box" id="chart2">
                <h3>Trânsito de Rotas</h3>
                <canvas id="graficoPizza"></canvas>
            </div>
        </div>

        <!-- Tabela -->
        <h3>Detalhes Gerais</h3>
        <table>
            <thead>
                <tr>
                    <th>Motorista</th>
                    <th>Rota</th>
                    <th>Data</th>
                    <th>Qtd. Passageiros</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-detalhes"></tbody>
        </table>
    </div>

    <!-- Scripts -->
    <script>
        let dadosGlobais = null;
        let chartLinha = null;
        let chartPizza = null;

        async function carregarDados() {
            const response = await fetch("/static/data/dashboard_dados_50.json");
            dadosGlobais = await response.json();

            // Preencher rotas
            const rotaSelect = document.getElementById("route");
            dadosGlobais.filtros.rotas.forEach(r => {
                const option = document.createElement("option");
                option.value = r.nome;
                option.textContent = r.nome;
                rotaSelect.appendChild(option);
            });

            atualizarDashboard();
        }

        function normalizarStatus(status) {
            switch (status) {
                case "Em Rota": return "emrota";
                case "Finalizado": return "finalizado";
                case "Pendente": return "pendente";
                default: return status.toLowerCase().replace(/\s+/g, "");
            }
        }

        function atualizarDashboard() {
            const dataInicio = document.getElementById("start-date").value;
            const dataFim = document.getElementById("end-date").value;
            const rotaSelecionada = document.getElementById("route").value;

            let registros = dadosGlobais.registros;

            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);

                if (fim < inicio) {
                    alert("A data final não pode ser menor que a data inicial.");
                    document.getElementById("end-date").value = "";
                    return;
                }

                const diffDias = (fim - inicio) / (1000 * 3600 * 24);
                if (diffDias > 7) {
                    alert("O período máximo é de 7 dias.");
                    document.getElementById("end-date").value = "";
                    return;
                }

                registros = registros.filter(r => {
                    const data = new Date(r.data);
                    return data >= inicio && data <= fim;
                });
            } else if (dataInicio) {
                registros = registros.filter(r => r.data === dataInicio);
            }

            if (rotaSelecionada !== "all") {
                registros = registros.filter(r => r.rota === rotaSelecionada);
            }

            // === Atualizar Cards ===
            document.getElementById("card-alunos").textContent = dadosGlobais.alunos.length;
            document.getElementById("card-escolas").textContent = dadosGlobais.filtros.escolas.length;
            document.getElementById("card-novos").textContent = registros.length;

            // === Atualizar Gráfico Linha ===
            const labels = registros.map(r => r.dia_semana);
            const presencas = registros.map(r => r.presencas);
            const faltas = registros.map(r => r.faltas);

            if (chartLinha) chartLinha.destroy();
            chartLinha = new Chart(document.getElementById("graficoLinha"), {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        {
                            label: "Presenças",
                            data: presencas,
                            borderColor: "green",
                            backgroundColor: "rgba(0, 255, 0, 0.1)",
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: "Faltas",
                            data: faltas,
                            borderColor: "red",
                            backgroundColor: "rgba(255, 0, 0, 0.3)",
                            fill: true,
                            tension: 0.3
                        }
                    ]
                }
            });

            // === Atualizar Gráfico Pizza ===
            const statusCount = { "Finalizado": 0, "Em Rota": 0, "Pendente": 0 };
            registros.forEach(r => { 
                if (statusCount[r.status] !== undefined) {
                    statusCount[r.status]++;
                }
            });

            if (chartPizza) chartPizza.destroy();
            chartPizza = new Chart(document.getElementById("graficoPizza"), {
                type: "doughnut",
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: ["#4CAF50", "#FFC107", "#F44336"]
                    }]
                }
            });

            // === Preencher tabela ===
            const tabela = document.getElementById("tabela-detalhes");
            tabela.innerHTML = "";
            registros.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${r.motorista}</td>
                    <td>${r.rota}</td>
                    <td>${r.data}</td>
                    <td>${r.qtd_passageiros}</td>
                    <td><span class="status ${normalizarStatus(r.status)}">${r.status}</span></td>
                `;
                tabela.appendChild(tr);
            });
        }

        document.getElementById("start-date").addEventListener("change", atualizarDashboard);
        document.getElementById("end-date").addEventListener("change", atualizarDashboard);
        document.getElementById("route").addEventListener("change", atualizarDashboard);

        carregarDados();
    </script>
</body>
</html>
